#pragma checksum "C:\Programowanie\Praca\Praktyki Hart Sp. z o.o\Projects\LinkedInLib\LinkedInSalesToolGUI\LinkedInSalesToolGUI\Pages\Index.razor" "{ff1816ec-aa5e-4d10-87f7-6f4963833460}" "550a423b766d5b8f05fc9c43adc2c3e86b4bd5ca"
// <auto-generated/>
#pragma warning disable 1591
namespace LinkedInSalesToolGUI.Pages
{
    #line hidden
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Threading.Tasks;
    using Microsoft.AspNetCore.Components;
#nullable restore
#line 1 "C:\Programowanie\Praca\Praktyki Hart Sp. z o.o\Projects\LinkedInLib\LinkedInSalesToolGUI\LinkedInSalesToolGUI\_Imports.razor"
using System.Net.Http;

#line default
#line hidden
#nullable disable
#nullable restore
#line 2 "C:\Programowanie\Praca\Praktyki Hart Sp. z o.o\Projects\LinkedInLib\LinkedInSalesToolGUI\LinkedInSalesToolGUI\_Imports.razor"
using Microsoft.AspNetCore.Authorization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 3 "C:\Programowanie\Praca\Praktyki Hart Sp. z o.o\Projects\LinkedInLib\LinkedInSalesToolGUI\LinkedInSalesToolGUI\_Imports.razor"
using Microsoft.AspNetCore.Components.Authorization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 4 "C:\Programowanie\Praca\Praktyki Hart Sp. z o.o\Projects\LinkedInLib\LinkedInSalesToolGUI\LinkedInSalesToolGUI\_Imports.razor"
using Microsoft.AspNetCore.Components.Forms;

#line default
#line hidden
#nullable disable
#nullable restore
#line 5 "C:\Programowanie\Praca\Praktyki Hart Sp. z o.o\Projects\LinkedInLib\LinkedInSalesToolGUI\LinkedInSalesToolGUI\_Imports.razor"
using Microsoft.AspNetCore.Components.Routing;

#line default
#line hidden
#nullable disable
#nullable restore
#line 6 "C:\Programowanie\Praca\Praktyki Hart Sp. z o.o\Projects\LinkedInLib\LinkedInSalesToolGUI\LinkedInSalesToolGUI\_Imports.razor"
using Microsoft.AspNetCore.Components.Web;

#line default
#line hidden
#nullable disable
#nullable restore
#line 7 "C:\Programowanie\Praca\Praktyki Hart Sp. z o.o\Projects\LinkedInLib\LinkedInSalesToolGUI\LinkedInSalesToolGUI\_Imports.razor"
using Microsoft.AspNetCore.Components.Web.Virtualization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 8 "C:\Programowanie\Praca\Praktyki Hart Sp. z o.o\Projects\LinkedInLib\LinkedInSalesToolGUI\LinkedInSalesToolGUI\_Imports.razor"
using Microsoft.JSInterop;

#line default
#line hidden
#nullable disable
#nullable restore
#line 9 "C:\Programowanie\Praca\Praktyki Hart Sp. z o.o\Projects\LinkedInLib\LinkedInSalesToolGUI\LinkedInSalesToolGUI\_Imports.razor"
using LinkedInSalesToolGUI;

#line default
#line hidden
#nullable disable
#nullable restore
#line 10 "C:\Programowanie\Praca\Praktyki Hart Sp. z o.o\Projects\LinkedInLib\LinkedInSalesToolGUI\LinkedInSalesToolGUI\_Imports.razor"
using LinkedInSalesToolGUI.Shared;

#line default
#line hidden
#nullable disable
#nullable restore
#line 2 "C:\Programowanie\Praca\Praktyki Hart Sp. z o.o\Projects\LinkedInLib\LinkedInSalesToolGUI\LinkedInSalesToolGUI\Pages\Index.razor"
using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage;

#line default
#line hidden
#nullable disable
#nullable restore
#line 3 "C:\Programowanie\Praca\Praktyki Hart Sp. z o.o\Projects\LinkedInLib\LinkedInSalesToolGUI\LinkedInSalesToolGUI\Pages\Index.razor"
using LinkedInSalesToolGUI.Data;

#line default
#line hidden
#nullable disable
#nullable restore
#line 4 "C:\Programowanie\Praca\Praktyki Hart Sp. z o.o\Projects\LinkedInLib\LinkedInSalesToolGUI\LinkedInSalesToolGUI\Pages\Index.razor"
using LinkedInLib;

#line default
#line hidden
#nullable disable
    [Microsoft.AspNetCore.Components.RouteAttribute("/")]
    public partial class Index : Microsoft.AspNetCore.Components.ComponentBase
    {
        #pragma warning disable 1998
        protected override void BuildRenderTree(Microsoft.AspNetCore.Components.Rendering.RenderTreeBuilder __builder)
        {
            __builder.AddMarkupContent(0, @"<link rel=""stylesheet"" href=""https://unpkg.com/purecss@2.0.6/build/pure-min.css"" integrity=""sha384-Uu6IeWbM+gzNVXJcM9XV3SohHtmWE+3VGi496jvgX1jyvDTXfdK+rfZc8C1Aehk5"" crossorigin=""anonymous"" b-y2qfmc0bvt>
<meta name=""viewport"" content=""width=device-width, initial-scale=1"" b-y2qfmc0bvt>
");
            __builder.AddMarkupContent(1, "<h1 b-y2qfmc0bvt>LinkedIn Sales Tool</h1>\r\n<hr b-y2qfmc0bvt>");
#nullable restore
#line 12 "C:\Programowanie\Praca\Praktyki Hart Sp. z o.o\Projects\LinkedInLib\LinkedInSalesToolGUI\LinkedInSalesToolGUI\Pages\Index.razor"
 if (!databaseConnectionCreated)
{

#line default
#line hidden
#nullable disable
            __builder.AddMarkupContent(2, "<div class=\"loader\" b-y2qfmc0bvt></div>");
#nullable restore
#line 15 "C:\Programowanie\Praca\Praktyki Hart Sp. z o.o\Projects\LinkedInLib\LinkedInSalesToolGUI\LinkedInSalesToolGUI\Pages\Index.razor"
}
else if (Settings.databaseConnectionValid)
{


#line default
#line hidden
#nullable disable
            __builder.AddMarkupContent(3, "<p style=\"color:limegreen\" b-y2qfmc0bvt><em b-y2qfmc0bvt>You have a valid database connection</em></p>");
            __builder.AddMarkupContent(4, "<p b-y2qfmc0bvt>You may begin synchronisation</p>\r\n    <br b-y2qfmc0bvt>");
#nullable restore
#line 22 "C:\Programowanie\Praca\Praktyki Hart Sp. z o.o\Projects\LinkedInLib\LinkedInSalesToolGUI\LinkedInSalesToolGUI\Pages\Index.razor"
     if (showAlert)
    {

#line default
#line hidden
#nullable disable
            __builder.OpenElement(5, "div");
            __builder.AddAttribute(6, "class", "alert");
            __builder.AddAttribute(7, "b-y2qfmc0bvt");
            __builder.OpenElement(8, "span");
            __builder.AddAttribute(9, "class", "closebtn");
            __builder.AddAttribute(10, "onclick", Microsoft.AspNetCore.Components.EventCallback.Factory.Create<Microsoft.AspNetCore.Components.Web.MouseEventArgs>(this, 
#nullable restore
#line 25 "C:\Programowanie\Praca\Praktyki Hart Sp. z o.o\Projects\LinkedInLib\LinkedInSalesToolGUI\LinkedInSalesToolGUI\Pages\Index.razor"
                                               () =>showAlert = false

#line default
#line hidden
#nullable disable
            ));
            __builder.AddAttribute(11, "b-y2qfmc0bvt");
            __builder.AddContent(12, "Ã—");
            __builder.CloseElement();
            __builder.AddMarkupContent(13, "\r\n            ");
            __builder.AddMarkupContent(14, "<strong b-y2qfmc0bvt>Warning!</strong> Please set the timer!\r\n        ");
            __builder.CloseElement();
#nullable restore
#line 28 "C:\Programowanie\Praca\Praktyki Hart Sp. z o.o\Projects\LinkedInLib\LinkedInSalesToolGUI\LinkedInSalesToolGUI\Pages\Index.razor"
    }

#line default
#line hidden
#nullable disable
#nullable restore
#line 30 "C:\Programowanie\Praca\Praktyki Hart Sp. z o.o\Projects\LinkedInLib\LinkedInSalesToolGUI\LinkedInSalesToolGUI\Pages\Index.razor"
     if (!isSyncLoopOn && !isCurrentlySyncing)
    {

#line default
#line hidden
#nullable disable
            __builder.OpenElement(15, "button");
            __builder.AddAttribute(16, "onclick", Microsoft.AspNetCore.Components.EventCallback.Factory.Create<Microsoft.AspNetCore.Components.Web.MouseEventArgs>(this, 
#nullable restore
#line 32 "C:\Programowanie\Praca\Praktyki Hart Sp. z o.o\Projects\LinkedInLib\LinkedInSalesToolGUI\LinkedInSalesToolGUI\Pages\Index.razor"
                           StartSync

#line default
#line hidden
#nullable disable
            ));
            __builder.AddAttribute(17, "class", "pure-button");
            __builder.AddAttribute(18, "b-y2qfmc0bvt");
            __builder.AddMarkupContent(19, "<i class=\"fas fa-sync\" b-y2qfmc0bvt></i> Synchronise once");
            __builder.CloseElement();
            __builder.AddMarkupContent(20, "\r\n        <br b-y2qfmc0bvt>\r\n        <br b-y2qfmc0bvt>\r\n        ");
            __builder.OpenElement(21, "button");
            __builder.AddAttribute(22, "onclick", Microsoft.AspNetCore.Components.EventCallback.Factory.Create<Microsoft.AspNetCore.Components.Web.MouseEventArgs>(this, 
#nullable restore
#line 35 "C:\Programowanie\Praca\Praktyki Hart Sp. z o.o\Projects\LinkedInLib\LinkedInSalesToolGUI\LinkedInSalesToolGUI\Pages\Index.razor"
                           SyncLoop

#line default
#line hidden
#nullable disable
            ));
            __builder.AddAttribute(23, "class", "pure-button");
            __builder.AddAttribute(24, "b-y2qfmc0bvt");
            __builder.AddMarkupContent(25, "<i class=\"fas fa-sync\" b-y2qfmc0bvt></i> Synchronise in loop");
            __builder.CloseElement();
            __builder.AddMarkupContent(26, "\r\n        ");
            __builder.OpenElement(27, "input");
            __builder.AddAttribute(28, "type", "time");
            __builder.AddAttribute(29, "class", "e-control e-timepicker e-lib e-input");
            __builder.AddAttribute(30, "value", Microsoft.AspNetCore.Components.BindConverter.FormatValue(
#nullable restore
#line 36 "C:\Programowanie\Praca\Praktyki Hart Sp. z o.o\Projects\LinkedInLib\LinkedInSalesToolGUI\LinkedInSalesToolGUI\Pages\Index.razor"
                                                                               syncTimer

#line default
#line hidden
#nullable disable
            , format: "HH:mm:ss", culture: global::System.Globalization.CultureInfo.InvariantCulture));
            __builder.AddAttribute(31, "onchange", Microsoft.AspNetCore.Components.EventCallback.Factory.CreateBinder(this, __value => syncTimer = __value, syncTimer, format: "HH:mm:ss", culture: global::System.Globalization.CultureInfo.InvariantCulture));
            __builder.SetUpdatesAttributeName("value");
            __builder.AddAttribute(32, "b-y2qfmc0bvt");
            __builder.CloseElement();
#nullable restore
#line 37 "C:\Programowanie\Praca\Praktyki Hart Sp. z o.o\Projects\LinkedInLib\LinkedInSalesToolGUI\LinkedInSalesToolGUI\Pages\Index.razor"
    }
    else if (isCurrentlySyncing)
    {
        

#line default
#line hidden
#nullable disable
            __builder.AddMarkupContent(33, "\r\n            Currently synchronising, please wait patiently.\r\n        ");
#nullable restore
#line 42 "C:\Programowanie\Praca\Praktyki Hart Sp. z o.o\Projects\LinkedInLib\LinkedInSalesToolGUI\LinkedInSalesToolGUI\Pages\Index.razor"
               
    }
    else if (isSyncLoopOn)
    {

#line default
#line hidden
#nullable disable
            __builder.OpenElement(34, "button");
            __builder.AddAttribute(35, "onclick", Microsoft.AspNetCore.Components.EventCallback.Factory.Create<Microsoft.AspNetCore.Components.Web.MouseEventArgs>(this, 
#nullable restore
#line 46 "C:\Programowanie\Praca\Praktyki Hart Sp. z o.o\Projects\LinkedInLib\LinkedInSalesToolGUI\LinkedInSalesToolGUI\Pages\Index.razor"
                           stopSync

#line default
#line hidden
#nullable disable
            ));
            __builder.AddAttribute(36, "class", "pure-button");
            __builder.AddAttribute(37, "b-y2qfmc0bvt");
            __builder.AddMarkupContent(38, "<i class=\"fas fa-stop\" b-y2qfmc0bvt></i> Stop synchronising");
            __builder.CloseElement();
#nullable restore
#line 47 "C:\Programowanie\Praca\Praktyki Hart Sp. z o.o\Projects\LinkedInLib\LinkedInSalesToolGUI\LinkedInSalesToolGUI\Pages\Index.razor"
    }

#line default
#line hidden
#nullable disable
            __builder.AddMarkupContent(39, "<br b-y2qfmc0bvt>\r\n    <hr b-y2qfmc0bvt>");
            __builder.OpenElement(40, "a");
            __builder.AddAttribute(41, "href", "/messages");
            __builder.AddAttribute(42, "b-y2qfmc0bvt");
            __builder.AddContent(43, 
#nullable restore
#line 51 "C:\Programowanie\Praca\Praktyki Hart Sp. z o.o\Projects\LinkedInLib\LinkedInSalesToolGUI\LinkedInSalesToolGUI\Pages\Index.razor"
                             CountNotifications()

#line default
#line hidden
#nullable disable
            );
            __builder.CloseElement();
            __builder.AddMarkupContent(44, " new messages recieved.\r\n    ");
#nullable restore
#line 52 "C:\Programowanie\Praca\Praktyki Hart Sp. z o.o\Projects\LinkedInLib\LinkedInSalesToolGUI\LinkedInSalesToolGUI\Pages\Index.razor"
           

}
else
{

#line default
#line hidden
#nullable disable
            __builder.AddMarkupContent(45, "<em b-y2qfmc0bvt><a href=\"/Settings\" style=\"color:red\" b-y2qfmc0bvt>\r\n            Couldn\'t establish a connection to the database!<br b-y2qfmc0bvt>\r\n            Resolve this issue on the settings page.\r\n        </a></em>");
#nullable restore
#line 63 "C:\Programowanie\Praca\Praktyki Hart Sp. z o.o\Projects\LinkedInLib\LinkedInSalesToolGUI\LinkedInSalesToolGUI\Pages\Index.razor"
}

#line default
#line hidden
#nullable disable
        }
        #pragma warning restore 1998
#nullable restore
#line 65 "C:\Programowanie\Praca\Praktyki Hart Sp. z o.o\Projects\LinkedInLib\LinkedInSalesToolGUI\LinkedInSalesToolGUI\Pages\Index.razor"
         
    bool databaseConnectionCreated = false;
    List<ClientData> clientDatas = new List<ClientData>();
    Account account = new Account();
    int amountOfNotifications = 0;

    string[] currentMessageInputValues = new string[4];
    DateTime[] dateTimes = new DateTime[2];
    int[] timeSpans = new int[3];
    string[] databaseConnection = new string[5];
    readonly List<string> messageVariableNames = new List<string>() { "Initial Message", "Followup Message", "Special Account Initial Message", "Special Account Followup Message" };
    readonly List<string> timeVariableNames = new List<string>() { "Tool start time", "Tool stop time" };
    readonly List<string> daysVariableNames = new List<string>() { "Time before Initial message", "Time before Followup message", "Time after Followup message" };
    readonly List<string> databaseVariableNames = new List<string>() { "server", "database", "port", "username", "password" };

    System.Timers.Timer t;
    DateTime syncTimer;
    Timers timers;
    bool isSyncLoopOn = false;
    bool isCurrentlySyncing = false;
    bool showAlert = false;

    protected override async Task OnInitializedAsync()
    {

    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            StateHasChanged();
            await ReadSettingsForSync(); // TODO: move out of if, add statechanged inside
            CreateDatabaseConnection();
            databaseConnectionCreated = true;
            await ReadSyncTimer();
            await ReadSyncFinishDateTime();

            LinkedInController.logger.Info("First render of index page completed");

        }

    }

    private async void CreateDatabaseConnection()
    {
        int i = 0;
        foreach (var item in databaseVariableNames)
        {

            var result = await BrowserStorage.GetAsync<string>(databaseVariableNames[i]);
            databaseConnection[i] = result.Success ? result.Value : "";
            i++;
        }
        if (await dbService.CheckDatabaseConnection(databaseConnection[0], databaseConnection[1], databaseConnection[2], databaseConnection[3], databaseConnection[4]))
        {
            Settings.databaseConnectionValid = true;
            Startup.databaseManagerSet = true;
            Startup.databaseManager = new DatabaseManager(databaseConnection[0], databaseConnection[1], databaseConnection[2], databaseConnection[3], databaseConnection[4]);

        }
        else
        {
            Settings.databaseConnectionValid = false;
            Startup.databaseManagerSet = false;
        }
        StateHasChanged();
    }

    private async Task ReadSettingsForSync()
    {
        int j = 0;
        foreach (var value in currentMessageInputValues)
        {
            await ReadMessage(j);
            j++;
        }
        j = 0;
        foreach (var value in dateTimes)
        {
            await ReadTime(j);
            j++;
        }
        j = 0;
        foreach (var value in timeSpans)
        {
            await ReadTimeWithDays(j);
            j++;
        }
        timers.TimeBeforeInitialMessage = TimeSpan.FromDays(timeSpans[0]);
        timers.TimeBeforeFollowupMessage = TimeSpan.FromDays(timeSpans[1]);
        timers.TimeAfterFollowupMessage = TimeSpan.FromDays(timeSpans[2]);

        timers.ToolStartTime = TimeSpan.FromHours(dateTimes[0].Hour);
        timers.ToolStopTime = TimeSpan.FromHours(dateTimes[1].Hour);
    }

    private async Task StartSync()
    {
        if (!isSyncLoopOn) await SaveSyncTimer();
        isCurrentlySyncing = true;
        await syncService.Synchronise(timers, currentMessageInputValues);
        await SaveSyncFinishDateTime();
        isCurrentlySyncing = false;
    }

    private void SyncLoop()
    {
        if (syncTimer.Hour != 0 || syncTimer.Minute != 0)
        {
            SaveSyncTimer();
            t = new System.Timers.Timer();
            t.AutoReset = true;
            t.Elapsed += new System.Timers.ElapsedEventHandler(t_Elapsed);
            t.Interval = GetInterval();
            isSyncLoopOn = true;
            t.Start();
            LinkedInController.logger.Info($"loop started at: {DateTime.Now.ToString("dd-MM-yyyy  H:mm:ss")}");
            LinkedInController.logger.Info($"Interval is {new TimeSpan(0, 0, 0, 0, Convert.ToInt32(t.Interval))}");
        }
        else
        {
            showAlert = true;
        }

    }

    private double GetInterval()
    {
        DateTime now = DateTime.Now;
        return (syncTimer.Hour * 60 * 60 * 1000) + (syncTimer.Minute * 1 * 1000);
    }

    private async void t_Elapsed(object sender, System.Timers.ElapsedEventArgs e)
    {
        t.Stop();
        LinkedInController.logger.Info($"Loop finished at: {DateTime.Now.ToString("H:mm:ss")} starting sync");
        await StartSync();
        t.Interval = GetInterval();
        t.Start();
        LinkedInController.logger.Info($"Loop starting at: {DateTime.Now.ToString("H:mm:ss")}");

    }

    private void stopSync()
    {
        t.Stop();
        isSyncLoopOn = false;
        LinkedInController.logger.Info("Synchronisation loop has been stopped");
    }

    public async void CheckNotifications(AccountCreditentials accountCreditentials)
    {
        clientDatas = await dbService.CheckNotificationsForAccount(accountCreditentials.Id);
    }

    public int CountNotifications()
    {
        amountOfNotifications = 0;
        foreach (var accountCred in account.GetAllAccountsCreditentials())
        {
            CheckNotifications(accountCred);
            if (clientDatas.Any())
            {
                amountOfNotifications += clientDatas.Count;
            }
        }
        return amountOfNotifications;
    }

    private async Task ReadMessage(int id)
    {
        var result = await BrowserStorage.GetAsync<string>(messageVariableNames[id]);
        currentMessageInputValues[id] = result.Success ? result.Value : "";
    }

    private async Task ReadTimeWithDays(int id)
    {
        var result = await BrowserStorage.GetAsync<int>(daysVariableNames[id]);
        timeSpans[id] = result.Success ? result.Value : 0;
    }

    private async Task ReadTime(int id)
    {
        var result = await BrowserStorage.GetAsync<DateTime>(timeVariableNames[id]);
        dateTimes[id] = result.Success ? result.Value : new DateTime(2);
    }

    private async Task SaveSyncTimer()
    {
        await BrowserStorage.SetAsync("SyncTimer", syncTimer);
    }

    private async Task ReadSyncTimer()
    {
        var result = await BrowserStorage.GetAsync<DateTime>("SyncTimer");
        syncTimer = result.Success ? result.Value : new DateTime(0);
    }

    private async Task SaveSyncFinishDateTime()
    {
        await BrowserStorage.SetAsync("SyncFinishDate", DateTime.Now);
    }

    private async Task ReadSyncFinishDateTime()
    {
        var result = await BrowserStorage.GetAsync<DateTime>("SyncFinishDate");
        Startup.lastSyncDateTime = result.Success ? result.Value : new DateTime(0);
    }


#line default
#line hidden
#nullable disable
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private SyncService syncService { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private DatabaseService dbService { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private ProtectedLocalStorage BrowserStorage { get; set; }
    }
}
#pragma warning restore 1591
